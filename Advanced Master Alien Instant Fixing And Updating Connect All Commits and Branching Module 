name: Synthetic Alien Merger & Multi-Branch Sync

on:
  push:
    branches: [ "*" ] # Triggers on EVERY branch push
  workflow_dispatch: # Allows you to trigger the "MergÃ¨r" manually

jobs:
  merge-and-repair:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for all branches
          token: ${{ secrets.GITHUB_TOKEN }}

      # 1. THE REPAIR ENGINE: Fixes broken syntax before merging
      - name: Instant Code Healing
        run: |
          npm install -g prettier eslint
          # Force fix all files to prevent "broken code" conflicts
          prettier --write "**/*.{js,ts,json,md,py}" || true
          eslint --fix . --ext .js,.ts || true

      # 2. THE SYNTHETIC MERGER: Syncs current push to ALL branches
      - name: Multi-Branch Infusion
        run: |
          git config --global user.name "Synthetic-AI-Merger"
          git config --global user.email "ai@anderson-creek.local"
          
          # Get a list of all remote branches
          BRANCHES=$(git branch -r | grep -v '->' | sed 's/origin\///g')
          CURRENT_BRANCH=${{ github.ref_name }}

          for branch in $BRANCHES; do
            if [ "$branch" != "$CURRENT_BRANCH" ]; then
              echo "Merging $CURRENT_BRANCH into $branch..."
              git checkout $branch
              # 'recursive' with 'theirs' strategy automatically resolves 
              # most conflicts by favoring the new incoming code
              git merge $CURRENT_BRANCH -X theirs --allow-unrelated-histories -m "Synthetic Merger: Integrated from $CURRENT_BRANCH"
              git push origin $branch
            fi
          done

      # 3. XRP LEDGER COMMIT: Finalizing the Chain
      - name: XRP Validation & Final Commit
        run: |
          git checkout main
          echo "Commit Timestamp: $(date)" >> xrp_ledger_sync.log
          git add .
          git commit -m "XRP Synthetic Sync: All branches aligned." || echo "No changes to commit"
          git push origin main
